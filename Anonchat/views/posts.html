<script>
	function getQuery(name){
		// alert(window.location.search);
	   	if(name=(new RegExp('[?&]'+encodeURIComponent(name)+'=([^&]*)')).exec(window.location.search))
	        return decodeURIComponent(name[1]);

	    else return undefined;
	}

	// alert(window.location.search);



	var posts = [];
	var wall = getQuery("wall") || 0;
	var topic = getQuery("topic");

	if(topic !== undefined) {
		var topic_tag = SESSION_CACHE.topic_tags[topic];
		document.getElementById("header").innerHTML += " for topic "+topic_tag;
		document.getElementById("topic_tag").value = topic_tag;
	}
	else {
		document.getElementById("header").innerHTML += " for all topics";
	}

	PINE.addEventListener("DOMContentLoaded", function() {
	    
	    var target = PATH_TO_SERVER+"/aardvark/posts?wall="+wall;
	    if(topic) { target += "&topic="+topic; }

	    var request = new XMLHttpRequest();
	    // request.responseType = 'text';
	    request.open('GET', target, true);

	    request.onload = function() {
	        if (request.status >= 200 && request.status < 400) {
	            // Success!
	            var response = request.responseText;
	            // console.log(response);
	            var data = JSON.parse(response);
	            // console.log(data);
	            // console.log(data.name);

	            posts = data.vals;
	            PINE.getNodeFunction($("postlist")[0], "update")();
	        } else {
	            // We reached our target server, but it returned an error
	            alert("include src '"+target+"' does not exist")
	        }
	    };



	    request.onerror = function() {
	        // There was a connection error of some sort
	        alert("include src '"+target+"' does not exist")
	    };

	    request.send();
	});





	function addComment(addMe) {
        posts.push(addMe);

        $("postlist")[0].FNS.update();

        var request = new XMLHttpRequest();
        request.open('POST', PATH_TO_SERVER+'/aardvark/posts', true);
        request.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');

        var topic_tag = document.getElementById("topic_tag").value;
	  	var data = {post_body: addMe, post_wall_id: wall, post_topic_tag: topic_tag};

	  	request.send(JSON.stringify(data));

    }

</script>

<heading id="header">Posts</heading>

<postlist spawner="posts" autoRun="false">
	<post spawn>{{posts[i]}}</post>
</postlist>

<commentbox submitfn="addComment" placeholder="I think..."></commentbox>
#<input id="topic_tag" type="textarea"></input>

<button trigger="click" target="commentbox" fn="submit">
	Submit
</button>