<script>

PINE.createNeedle("[resizeHandle]", function() {
	this.addAttArg({
		argName: "resizables", 
		attNames: "resizeHandle", 
		argType: "string", 
		defaultVal: "~",
		isArrayable: true,
		// isArraySize: true
	});

	this.addAttArg({
		argName: "direction", 
		attNames: ["resizeHandleDirection", "resizeHandleDir", "resizeDirection", "resizeDir"], 
		argType: "string",
		defaultVal: "0 1 1 0",
		isArrayable: true
	});

	this.addOp(function(state) {
		var domNode = state.domNode;

		var cssQueries = state.getArg("resizables").split(",");
		var resizableNodes = [];
		for(var i = 0 ; i < cssQueries.length; i++) {
			var node = El.cssQuery(domNode, cssQueries[i])[0];
			if(node === undefined)
				PINE.err("could not find "+cssQueries[i]+" from node ", domNode);
			else
				resizableNodes[i] = node;
		}

		var directionStrings = state.getArg("direction").split(",");
		var directions = [];
		for(var i = 0 ; i < directionStrings.length; i++) {
			var chars = directionStrings[i].match(/\S/g);
			directions[i] = [];
			for(var c = 0; c < chars.length; c++) {
				directions[i][c] = parseFloat(chars[c]);
			}
		}

		
		domNode.addEventListener("mousedown", function(event) {
			var startX = event.pageX;
			var startY = event.pageY;
			var startSizes = [];
			var lastSizes = []
			var updates = [];

			for(var i = 0; i < resizableNodes.length; i++) {
				startSizes[i] = {};
				lastSizes[i] = {};
				updates[i] = {};
				lastSizes[i].width = startSizes[i].width = resizableNodes[i].offsetWidth;
				lastSizes[i].height = startSizes[i].height = resizableNodes[i].offsetHeight;
			} 

			
			
			var requestedFrame;
			

			var mousemove = function(event) {
					//
				var doFrameRequest = false;

				var dX = event.pageX - startX;
				var dY = event.pageY - startY;
				
				for(var i = 0; i < resizableNodes.length; i++) {
					var node = resizableNodes[i];
					var fourDir = directions[i];

					for(var d = 0; d < fourDir.length; d++) {
						var dir = fourDir[d];

						if(dir !== 0) {
							var dPx, heightOrWidth;

							if(d==0 || d==2) {
								dPx = dY;
								heightOrWidth = "height";
							}

							else if(d==1 || d==3) {
								dPx = dX;
								heightOrWidth = "width";
							}

							var size = startSizes[i][heightOrWidth] + (dPx * dir);
							if(size != lastSizes[i][heightOrWidth]) {
								updates[i][heightOrWidth] = size;
								doFrameRequest = true;
							}
						}
					}
				}

				if(doFrameRequest && requestedFrame == undefined) {
					requestedFrame = window.requestAnimationFrame(function() {
							//
						for(var i = 0; i < updates.length; i++) {
							var update = updates[i];
								//
							var node = resizableNodes[i];


							if(updates[i].width !== undefined)
								node.style.width = update.width+"px";

							if(updates[i].height !== undefined)
								node.style.height = update.height+"px";

							updates[i] = {};
						}

						requestedFrame = undefined;
					});
				}
			}
			document.body.addEventListener("mousemove", mousemove);

			var mouseup = function() {
				document.body.removeEventListener("mousemove", mousemove);
				document.body.removeEventListener("mouseup", mouseup);
			}
			document.body.addEventListener("mouseup", mouseup);

		});
		
	});
});	








</script>

<style>
	*[resizeHandle]
	{ z-index: 100; }
	
	*[resizeHandle].resize-n 
	{ cursor: n-resize; }
	
	*[resizeHandle].resize-e
	{ cursor: e-resize; }

	*[resizeHandle].resize-s
	{ cursor: s-resize; }

	*[resizeHandle].resize-w
	{ cursor: w-resize; }

	*[resizeHandle].resize-ne
	{ cursor: ne-resize; }
	
	*[resizeHandle].resize-se
	{ cursor: se-resize; }

	*[resizeHandle].resize-sw
	{ cursor: sw-resize; }

	*[resizeHandle].resize-nw
	{ cursor: nw-resize; }

	*[resizeHandle].resize-ns, *[resizeHandle].resize-sn
	{ cursor: ns-resize; }

	*[resizeHandle].resize-ew, *[resizeHandle].resize-we
	{ cursor: ew-resize; }

	*[resizeHandle].resize-ne-sw, *[resizeHandle].resize-sw-ne
	{ cursor: nesw-resize; }

	*[resizeHandle].resize-nw-se, *[resizeHandle].resize-se-nw
	{ cursor: nwse-resize; }

	*[resizeHandle].resize-all { 
		cursor: move; 
		border: 3px double rgba(0,0,0,0.35);
		height: 10px;
		width: 10px;
	}
</style>