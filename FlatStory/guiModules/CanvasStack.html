 <script type="text/javascript">
	

PINE.waitForNeed(["ELATE", "BASIC_INTERFACES"], function () {
	

	console.error("TODO: make the ui apply itstelf based off of a listener for canvas stack layer changes")



	/*********************************
	*	Canvas Stack 
	*********************************/
	CanvasStack = ELATE.create("CanvasStack", function() {

		this.implements("EventDispatcher");

		this.build = function(domNode) {
			var THIS = this;
			THIS.domNode = domNode;

			THIS.domNode.addEventListener("resizeChoose", function(event) {
				var width = THIS.domNode.offsetWidth;
				var height = THIS.domNode.offsetHeight;

				var currentChipSize = THIS.zoom * 16;

				var newChipsWide = Math.round(width/currentChipSize);
				var newChipsTall = Math.round(height/currentChipSize);

				if(THIS.currentDisplayable) 
					THIS.currentDisplayable.setChipsDimensions(newChipsWide, newChipsTall);

				THIS.updateSizings();
			});

			THIS.setZoom(2);
		}


		this.setDisplayable = function(setToMe) {
			var THIS = this;

			if(setToMe.domNode == undefined)
				PINE.err("can not set to item without domNode")

			if(THIS.currentDisplayable == setToMe) return;

			

			if(THIS.currentDisplayable) {
				THIS.currentDisplayable.domNode.remove();
				THIS.endRepeatDispatches(THIS.currentDisplayable, "LayerChange");
			}

			
			THIS.currentDisplayable = setToMe;

			THIS.domNode.appendChild(setToMe.domNode)
			THIS.repeatDispatches(THIS.currentDisplayable, "LayerChange");

			THIS.dispatchEvent({type:"LayerChange", new:THIS.currentDisplayable.currentLayer});
			THIS.updateSizings();
			
		}


		this.setZoom = function(zoom) {
			this.zoom = zoom;
			this.updateSizings();
		}

		this.zoomIn = function(increment) {
			increment = increment || 1;
			if(this.zoom > 1)
				this.setZoom(this.zoom + increment);
			else
				this.setZoom(this.zoom * 2);
		}

		this.zoomOut = function(increment) {
			increment = increment || 1;
			if(this.zoom > 1)
				this.setZoom(this.zoom - increment);
			else 
				this.setZoom(this.zoom/2.0);
			
		}

		this.updateSizings = function() {

			if(this.currentDisplayable) {

				var didChange = false;
				this.currentDisplayable.setAssetScale(this.zoom);

				var expectedWidth = this.currentDisplayable.domNode.style.width;
				if(this.domNode.offsetWidth !== expectedWidth) {
					this.domNode.style.width = expectedWidth;
					didChange = true;
				}

				var expectedHeight = this.currentDisplayable.domNode.style.height;
				if(this.domNode.offsetHeight !== expectedHeight) {
					this.domNode.style.height = expectedHeight;	
					didChange = true;	
				}

				if(didChange) {
					var event = {};
					event.type = "sizeChange";
					// event.row = thisMode.currentRow;
					this.dispatchEvent(event);
				}
			}		
			
		}

	});





	/*********************************
	*	PROJECT
	*********************************/
	// ELATE.create("InteractiveCanvasStack", function() {

	// 	this.evolvesFrom("CanvasStack");
	// 	// this.implements("EventDispatcher");

	// 	this.parseArgs = function(domNode) {
	// 		return {CanvasStack: [domNode]};
	// 	}

	// 	this.evolveThis = function() {
	// 		this.modes = [];
	// 		this.currentMode = undefined;
	// 		this.layerChangeListener = undefined;
	// 		// this.eventListeners = {};

	// 		if(this.currentDisplayable !== undefined)
	// 			this.setDisplayable(this.currentDisplayable);
	// 	}

	// 	this.setDisplayable = function(setToMe) {
	// 		var THIS = this;
	// 		if(THIS.currentDisplayable) 
	// 			THIS.currentDisplayable.removeEventListener("LayerChange", THIS.layerChangeListener);

	// 		THIS.super.CanvasStack.setDisplayable(setToMe);
	// 		THIS.updateModeFor(setToMe);

	// 		THIS.currentDisplayable.addEventListener("LayerChange", function(event) {
	// 			THIS.updateModeFor(event.new);
	// 		});
			
	// 	}

	// 	this.updateModeFor = function(updateFor) {

	// 		if(updateFor.currentLayer !== undefined)
	// 			updateFor = updateFor.currentLayer

	// 		var newMode = undefined;

	// 		for(var i = 0; newMode == undefined && i < this.modes.length; i++) {
	// 			if(this.modes[i].isCorrectUIFor(updateFor)) 
	// 				newMode = this.modes[i];
	// 		}

	// 		if(newMode != this.currentMode) {
	// 			if(this.currentMode)
	// 				this.currentMode.unplug();

	// 			this.currentMode = newMode;

	// 			if(this.currentMode) 
	// 				this.currentMode.plugIn();
	// 		}

	// 	}

	// 	this.registerMode = function(CanvasStackUI) {
	// 		this.modes.push(CanvasStackUI);

	// 		if(this.currentDisplayable)
	// 			this.updateModeFor(this.currentDisplayable);
	// 	}


	// 	this.updateSizings = function() {
	// 		this.super.CanvasStack.updateSizings();

	// 		if(this.currentMode)
	// 			this.currentMode.baseline();
	// 	}

	// });



	/*********************************
	*	Canvas Stack UI
	*********************************/
	ELATE.create("CanvasStackUI", function() {
		this.isAbstract();

		this.build = function(name, canvasStack) {
			var THIS = this;
			THIS.name = name;
			THIS.canvasStack = canvasStack;
			THIS.isPluggedIn = false;

			THIS.canvasStack.addEventListener("LayerChange", function(event) {
				var layer = event.new;
				THIS.observeLayerChange(layer);
			});

			THIS.canvasStack.addEventListener("sizeChange", function(){THIS.updateSizings()});
		}

		this.observeLayerChange = function(layer) {
			var THIS = this;
			var shouldPlug = THIS.isCorrectUIFor(layer);
			if(shouldPlug != THIS.isPluggedIn) {
				shouldPlug ? THIS.plugIn() : THIS.unplug();
				THIS.isPluggedIn = shouldPlug;
			}
		}

		this.plugIn = "abstract";
		this.unplug = "abstract";
		this.updateSizings = "abstract";

		this.isCorrectUIFor = "abstract"
	});






	/*********************************
	*	Chip Drawing Canvas Stack UI
	*********************************/
	ELATE.create("ChipCanvasStackUI", function() {
		this.extend("CanvasStackUI");

		this.build = function(canvasStack) {


			this.super.CanvasStackUI("Chip", canvasStack);

			var thisMode = this;

			var ui = this.ui = {};
			ui.domNode = document.createElement("canvas");
			ui.domNode.id = "ChipCanvasStackUI";
			ui.painter = ui.domNode.getContext("2d");
			ui.domNode.oncontextmenu = function() {return false;}
			ui.domNode.style.zIndex = 20;

			// ui.zoom = 3;
			this.mouseHeld = false;


			this.currentRow = 0;
			this.currentCol = 0;

			// var mouseTrails = [];
			var hueShift = 0.005;
			var hueOffset = 0;

			var dispatchChipEvent = function(eventType) {
				var event = {};
				event.type = eventType;
				event.row = thisMode.currentRow;
				event.col = thisMode.currentCol;
				event.layer = thisMode.canvasStack.currentDisplayable.currentLayer;
				thisMode.canvasStack.dispatchEvent(event);
			}

			ui.domNode.addEventListener("mousemove", function(event) {
				var y = event.layerY;
				var x = event.layerX;

				

				var chipSize = 16;//getsize
				var currentRow = thisMode.currentRow;
				var currentCol = thisMode.currentCol;
				var zoom = thisMode.canvasStack.zoom;//getsize

				var col = ~~(x/(chipSize * zoom));
				var row = ~~(y/(chipSize * zoom));


				
				if(currentCol !== col || currentRow !== row) {
					// console.log("MOVING", x, y);
					var clearX = (currentCol*chipSize)-10;
					var clearY = (currentRow*chipSize)-10;
					var clearSize = chipSize+20;

					hueOffset = (hueOffset + hueShift)%1;

					ui.painter.clearRect(clearX, clearY, clearSize, clearSize);

					thisMode.currentCol = currentCol = col;
					thisMode.currentRow = currentRow = row;

					var rgb = FLAT.Tools.HSV_to_RGB(hueOffset, 0.3, 1);
					FLAT.Tools.setColor(ui.painter, rgb[0], rgb[1], rgb[2], 0.8);
					ui.painter.strokeRect(col*chipSize, row*chipSize, chipSize, chipSize);

					if(thisMode.mouseHeld) {
						dispatchChipEvent("ChipDrag");
					}

				}
			});


			ui.domNode.addEventListener("mousedown", function(event) {
				thisMode.mouseHeld = true;
				dispatchChipEvent("ChipPress");
			});

			document.body.addEventListener("mouseup", function(event) {
				thisMode.mouseHeld = false;
				dispatchChipEvent("ChipRelease");
			});

		}


		this.plugIn = function() {
			this.canvasStack.domNode.appendChild(this.ui.domNode);

			this.baseline();
		}

		this.unplug = function() {
			this.ui.domNode.remove();
		}



		this.baseline = function() {
			this.mouseHeld = false;
			this.updateSizings();
		}

		this.updateSizings = function() {
			var displayed = this.canvasStack.currentDisplayable;
			this.ui.domNode.width = displayed.width;
			this.ui.domNode.height = displayed.height;
			this.ui.domNode.style.width = displayed.domNode.style.width;
			this.ui.domNode.style.height = displayed.domNode.style.height;
		}


		this.isCorrectUIFor = function(layer) {
			return layer.inheritsFrom && layer.inheritsFrom("SeeableChipLayer")
		}


	});



});






</script>





<style>
canvasStack {
	display: inline-block;
	position: relative;
	margin: 200px;
	/*height: 768px;*/
	/*width: 768px;*/
	background: #1F1F1F;
	box-shadow: 5px 5px 25px rgba(0,0,0,0.3);
}

	canvasStack :not(resize) {
		position: absolute;
		top:0px;
		left: 0px;
		/*width: 100%;*/
		/*height: 100%;*/
		
		image-rendering: -moz-crisp-edges;
	}

		canvasStack.soloSelected canvas {
			opacity: var(--noSoloOpacity);
		}

		canvasStack.soloSelected canvas.currentlySelectedLayer {
			opacity: 1;
		}

	canvasStack resize {
		opacity: 0.8;
	}

	

resize {
	border-color: black !important;
	background-color: #888 !important;
	/*opacity: 1 !important;*/
}

</style>





