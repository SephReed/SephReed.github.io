<script>



var Draw = FLAT.Draw = {};
Draw.canvas;

function switchChipDraw() {
	if(FLAT.Draw.canvas == undefined) {
		FLAT.Draw.canvas = {};
		FLAT.Draw.canvas.zoom = 3;
		FLAT.Draw.canvas.domNode = document.createElement("canvas");
		FLAT.Draw.canvas.painter = FLAT.Draw.canvas.domNode.getContext("2d");
	}

	var canvas = FLAT.Draw.canvas;

	var chipSize = Pal.currentChipset.chipSize;
	canvas.domNode.width = canvas.domNode.height = chipSize;

	var imageData = Pal.getCurrentChipData()

	canvas.painter.putImageData(imageData, 0, 0);


	while(FLAT.World.domNode.hasChildNodes())
		FLAT.World.domNode.lastChild.remove();


	FLAT.World.domNode.style.height = (chipSize * canvas.zoom) + "px";
	FLAT.World.domNode.style.width = (chipSize * canvas.zoom) + "px";

	FLAT.World.domNode.appendChild(canvas.domNode);

}




Draw.HSV_to_RGB = function(hue, saturation, value) {
	hue %= 1;

	var rgb;
	if(saturation == 0 || value == 0)
		rgb = [value, value, value];  //used car salesman rick jim here!

	else {
		rgb = [];
		var oneThird = 1/3;
		var twoThirds = 2/3;

		var rgbPos = []
		rgbPos[0] = ((hue+oneThird)%1)/twoThirds;  //at 0, red pos = 0.5 or peak of sine wave
		rgbPos[1] = hue/twoThirds;  //at .3333, green pos = 0.5 or peak of sine wave
		rgbPos[2] = (hue-oneThird)/twoThirds;  //at .6666, blue pos = 0.5 or peak of sine wave

		for(var i in rgbPos) {
			var pos = rgbPos[i];
			if(pos > 0 && pos < 1)
				rgb[i] = Math.sin(pos*Math.PI) * value;
			else
				rgb[i] = 0;
		}


		if(saturation < 1) {
			var max = Math.max(Math.max(rgb[0], rgb[1]), rgb[2]);

			for(var i in rgb)
				rgb[i] += (max-rgb[i]) * (1-saturation);
		}
	}

	for(var i in rgb) 
		rgb[i] *= 256;

	return rgb;
}



Draw.setColor = function(painter, r, g, b, a) {
	if(a !== undefined){
		painter.strokeStyle = "rgba("+r+", "+g+", "+b+", "+a+")";
		painter.fillStyle = "rgba("+r+", "+g+", "+b+", "+a+")";
	}
	else {
		painter.strokeStyle = "rgb("+r+", "+g+", "+b+")";
		painter.fillStyle = "rgb("+r+", "+g+", "+b+")";
	}
}



</script>