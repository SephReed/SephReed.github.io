<script type="text/javascript">
	



PINE.waitForNeed("Draw", function() {


 // FLAT.World.Editor.Draw.Tools
	Draw.Tools = {};

	Draw.Tools.icons = [];
	Draw.Tools.iconOrder = [
		"draw",
		"select",
		"fill",
		"pick",
		"zoom"
	]




	Draw.Tools.setIconSet = function(url, scale) {
		scale = scale || 2;

		var img = document.createElement("img");
		img.src = url;

		img.addEventListener("load", function() {

			Draw.Tools.icons=[];

			var args = FLAT.getPixelCodeArgs(img, "TUL");
			
			var chipSize = args ? args.chipWidth : img.naturalHeight;

			var canvas = document.createElement("canvas");
			canvas.width = canvas.height = chipSize * scale;
			canvas.style.imageRendering = "-moz-crisp-edges";
			// canvas.style.zIndex = "100";
			// canvas.style.position = "absolute";
			// canvas.style.height = "256px";
			// canvas.style.width = "256px";
			// canvas.style.backgroundColor = "#777";

			// console.log(canvas);

			// document.body.appendChild(canvas);

			var painter = canvas.getContext("2d");


			var hChips = args ? args.numChips : img.naturalWidth/chipSize;

			if(hChips % 1 !== 0) {
				PINE.err("chipSize incorrect");
				hChips = ~~hChips;
			}

			for(var h = 0; h < hChips; h++) {
				painter.clearRect(0, 0, scale*chipSize, scale*chipSize);

				drawScaledImage(img, painter, 
					h * chipSize, 0, chipSize, chipSize, 
					0, 0, scale, scale);




				var icon = {}
				icon.actionPoint = args.pointers[h];
				icon.url = canvas.toDataURL("image/png");

				icon.bgStyling = "url('"+icon.url+"')";				
				icon.cursorStyling = icon.bgStyling;

				if(icon.actionPoint)
					icon.cursorStyling += icon.actionPoint.x*scale+" "+icon.actionPoint.y*scale
				else {
					var center = ~~(chipSize*scale/2);
					icon.cursorStyling += center+" "+center;
				}

				icon.cursorStyling += ", auto";


				Draw.Tools.icons.push(icon);
			}	

			

			for(var i = 0; i < Draw.Tools.icons.length; i++) {

				var addMe = document.createElement("tool");
				addMe.style.backgroundImage = "url('"+Draw.Tools.icons[i].url+"')";

				var toolName = Draw.Tools.iconOrder[i];
				var tool = Draw.Tools.getTool(toolName);
				if(tool) {
					tool.icon = Draw.Tools.icons[i];
					tool.domNode = addMe;
				}	

				(function(i) {
					addMe.addEventListener("mousedown", function() {
						Draw.Tools.setTool(Draw.Tools.iconOrder[i]);
					});
				})(i);
				

				Draw.Tools.domNode.appendChild(addMe);
			}
		});



	}


	Draw.Tools.getTool = function(toolName) {
		if(toolName == undefined) return;
		toolName = toolName.charAt(0).toUpperCase() + toolName.slice(1).toLowerCase();
		return Draw.Tools[toolName];
	}







	Draw.Tools.eventBindings = {};
	Draw.Tools.eventBindings.mouseDown;
	Draw.Tools.eventBindings.mouseDrag;
	Draw.Tools.eventBindings.keyup;
	Draw.Tools.eventBindings.keydown;
	
	Draw.Tools.setTool = function(toolName) {
		var tool = Draw.Tools.getTool(toolName);

		if(tool !== undefined) {

			if(Draw.Tools.currentTool && Draw.Tools.currentTool.disengange)
				Draw.Tools.currentTool.disengange();


			Draw.Tools.currentTool
				= Draw.Tools.eventBindings.keyup 
				= Draw.Tools.eventBindings.keydown 
				= Draw.Tools.eventBindings.mouseDrag 
				= Draw.Tools.eventBindings.mouseDown 
				= tool;

			Draw.Tools.setDrawAreaCursor(toolName);
			

			if(Draw.Tools.currentTool.engage)
				Draw.Tools.currentTool.engage();
		}
	}

	Draw.Tools.setDrawAreaCursor = function(toolName) {
		var tool = Draw.Tools.getTool(toolName);
		// console.log(toolName, tool);
		if(tool && tool.icon)
			FLAT.drawArea.style.cursor = tool.icon.cursorStyling;
	}



	Draw.Tools.mouseDown = function(row, col) {
		if(Draw.Tools.eventBindings.mouseDown.mouseDown)
			Draw.Tools.eventBindings.mouseDown.mouseDown(row, col);
	}

	Draw.Tools.mouseDrag = function(row, col) {
		if(Draw.Tools.eventBindings.mouseDrag.mouseDrag)
			Draw.Tools.eventBindings.mouseDrag.mouseDrag(row, col);
	}

	Draw.Tools.keydown = function(key) {
		if(Draw.Tools.eventBindings.keydown.keydown)
			Draw.Tools.eventBindings.keydown.keydown(key);
	}

	Draw.Tools.keyup = function(key) {
		if(Draw.Tools.eventBindings.keyup.keyup)
			Draw.Tools.eventBindings.keyup.keyup(key);
	}




	/**************************
	*      TOOL TYPES         *
	**************************/


	Draw.Tools.Draw = {};
	Draw.Tools.Draw.mouseDown = Draw.Tools.Draw.mouseDrag = function(row, col) {
		CURRENT_LAYER.setChip(row, col, Pal.currentChipset.selectedChip.num);
	}

	Draw.Tools.Draw.keydown = function(key) {
		if(key == "Meta") {
			Draw.Tools.setDrawAreaCursor("Pick");
			Draw.Tools.eventBindings.mouseDown = Draw.Tools.getTool("Pick");
		}
	}

	Draw.Tools.Draw.keyup = function(key) {
		if(key == "Meta") {
			Draw.Tools.setDrawAreaCursor("Draw");
			Draw.Tools.eventBindings.mouseDown = Draw.Tools.getTool("Draw");
		}
	}

	Draw.Tools.setTool("Draw");



	Draw.Tools.Fill = {}
	Draw.Tools.Fill.mouseDown = Draw.Tools.Fill.spread = function(row, col, targetID, allowDiagonals) {
		if(row < 0 
		|| col < 0 
		|| CURRENT_LAYER.chips.length <= row 
		|| CURRENT_LAYER.chips[0].length <= col)
			return;

		if(targetID === undefined)
			targetID = CURRENT_LAYER.chips[row][col];

		if(Pal.currentChipset.selectedChip.num == targetID)
			return;

		if(CURRENT_LAYER.chips[row][col] == targetID) {
			CURRENT_LAYER.setChip(row, col, Pal.currentChipset.selectedChip.num);

			Draw.Tools.Fill.spread(row-1, col, targetID, allowDiagonals);
			Draw.Tools.Fill.spread(row+1, col, targetID, allowDiagonals);
			Draw.Tools.Fill.spread(row, col-1, targetID, allowDiagonals);
			Draw.Tools.Fill.spread(row, col+1, targetID, allowDiagonals);

			if(allowDiagonals == true) {
				Draw.Tools.Fill.spread(row-1, col-1, targetID, allowDiagonals);
				Draw.Tools.Fill.spread(row+1, col+1, targetID, allowDiagonals);
				Draw.Tools.Fill.spread(row+1, col-1, targetID, allowDiagonals);
				Draw.Tools.Fill.spread(row-1, col+1, targetID, allowDiagonals);
			}
		}
	}

	Draw.Tools.Fill.keydown = Draw.Tools.Draw.keydown;
	Draw.Tools.Fill.keyup = function(key) {
		if(key == "Meta") {
			Draw.Tools.setDrawAreaCursor("Fill");
			Draw.Tools.eventBindings.mouseDown = Draw.Tools.getTool("Fill");
		}
	}

	// var setBack;
	// Draw.Tools.Fill.engage = Draw.Tools.Draw.engage = function() {
	// 	console.log("extending");
	// 	document.body.addEventListener("keydown", function(event) {
	// 		// console.log(event);
	// 		if(event.key == "Meta") {
	// 			// setBack = Tool.currentTool;
	// 			Draw.Tools.setTool("Pick");
	// 		}
	// 	});
	// }
	// Draw.Tools.Fill.disengage = Draw.Tools.Draw.disengage = function() {

	// }


	Draw.Tools.Replace = {}
	Draw.Tools.Replace.mouseDown = function(row, col) {
		var targetID = CURRENT_LAYER.chips[row][col];
		for(var v = 0; v < 16; v++) {
			for(var h = 0; h < 16; h++) {
				if(CURRENT_LAYER.chips[v][h] == targetID)
					CURRENT_LAYER.setChip(v, h, Pal.currentChipset.selectedChip.num);
			}
		}
	}


	Draw.Tools.Pick = {}
	Draw.Tools.Pick.mouseDown = function(row, col) {
		var targetID = CURRENT_LAYER.chips[row][col];
		FLAT.Pallette.selectChip(targetID);
	}



	Draw.Tools.Zoom = {};
	Draw.Tools.Zoom.inNotOut = true;
	Draw.Tools.Zoom.keydown = function(key) {
		if(key == "Meta") 
			Draw.Tools.Zoom.inNotOut = false;
	}

	Draw.Tools.Zoom.keyup = function(key) {
		if(key == "Meta") 
			Draw.Tools.Zoom.inNotOut = true;
	}

	Draw.Tools.Zoom.mouseDown = function() {

	}




	PINE.signalNeedReady("DrawTools");


});


</script>



<style>

</style>






